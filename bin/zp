#!/usr/bin/env python3
"""
zp - Zellij Prompt: Run claude in rightmost stack, return focus to original pane.

This script integrates with a zellij layout that has stacked panes (like claude-dev.kdl).
It navigates to the rightmost pane, spawns a new claude session there, and returns focus
to your original pane so you can keep working.

Usage: zp <prompt>
Example: zp "fix the type errors in auth.ts"
"""

import subprocess
import sys


def run(cmd: list[str]) -> str:
    """Run shell command and return stdout."""
    return subprocess.run(cmd, capture_output=True, text=True).stdout


def zellij(*args: str) -> str:
    """Run a zellij action command. Wraps: zellij action <args>"""
    return run(["zellij", "action", *args])


def get_current_pane_id() -> str | None:
    """
    Get the pane ID we're currently in.

    Uses 'zellij action list-clients' which outputs:
      CLIENT_ID  ZELLIJ_PANE_ID  RUNNING_COMMAND
      12345      terminal_0      zsh

    Returns the pane ID (e.g., "terminal_0") or None if not found.
    """
    output = zellij("list-clients")
    for line in output.strip().split("\n")[1:]:  # skip header row
        parts = line.split()
        if len(parts) >= 2:
            return parts[1]
    return None


def main():
    # Require a prompt argument
    if not sys.argv[1:]:
        print("Usage: zp <prompt>")
        sys.exit(1)

    prompt = " ".join(sys.argv[1:])
    pane_name = prompt[:30]  # truncate for pane title

    # Save current position so we can return after spawning claude
    original_pane = get_current_pane_id()

    # Move to rightmost pane (keep moving until we stop changing panes)
    moves = 0
    while True:
        before = get_current_pane_id()
        zellij("move-focus", "right")
        moves += 1
        if get_current_pane_id() == before or moves > 20:
            break

    # Spawn claude in the stack (--stacked adds to existing stack instead of splitting)
    subprocess.run([
        "zellij", "run", "--stacked",
        "--", "claude", prompt
    ])

    # Give the pane a meaningful name (prompt summary)
    # Done separately because --name flag doesn't persist well
    zellij("rename-pane", pane_name)

    # Return focus to where we started
    if original_pane:
        zellij("focus-pane-with-id", original_pane)


if __name__ == "__main__":
    main()
