#!/usr/bin/env python3
"""Run claude in the tasks stack pane, return focus to original pane."""

import subprocess
import sys
import re


def run(cmd: list[str]) -> str:
    """Run command and return output."""
    return subprocess.run(cmd, capture_output=True, text=True).stdout


def zellij(*args: str) -> str:
    """Run zellij action."""
    return run(["zellij", "action", *args])


def get_current_pane_id() -> str | None:
    """Get current pane ID from list-clients."""
    output = zellij("list-clients")
    # Format: CLIENT_ID ZELLIJ_PANE_ID RUNNING_COMMAND
    for line in output.strip().split("\n")[1:]:  # skip header
        parts = line.split()
        if len(parts) >= 2:
            return parts[1]  # e.g., "terminal_0"
    return None


def parse_layout_panes(layout: str) -> list[dict]:
    """Parse KDL layout to extract pane info with positions."""
    panes = []
    # Track nesting to understand structure
    depth = 0
    in_stacked = False
    stacked_panes = []

    for line in layout.split("\n"):
        stripped = line.strip()

        # Track depth
        depth += line.count("{") - line.count("}")

        # Detect stacked sections
        if "stacked=true" in stripped:
            in_stacked = True
            stacked_panes = []

        # Parse pane lines
        if stripped.startswith("pane"):
            pane_info = {"line": stripped, "stacked": in_stacked}

            # Extract name
            name_match = re.search(r'name="([^"]+)"', stripped)
            if name_match:
                pane_info["name"] = name_match.group(1)

            # Check if focused
            if "focus=true" in stripped:
                pane_info["focused"] = True

            # Check if expanded (in stack)
            if "expanded=true" in stripped:
                pane_info["expanded"] = True

            panes.append(pane_info)
            if in_stacked:
                stacked_panes.append(pane_info)

        # End of stacked section
        if in_stacked and "}" in stripped and depth < 3:
            in_stacked = False

    return panes


def find_tasks_stack_index(layout: str) -> int:
    """Find which stacked section contains 'tasks' pane. Returns 0-based index."""
    stack_idx = -1
    in_stacked = False
    depth = 0
    base_depth = 0

    for line in layout.split("\n"):
        stripped = line.strip()
        prev_depth = depth
        depth += line.count("{") - line.count("}")

        if "stacked=true" in stripped:
            stack_idx += 1
            in_stacked = True
            base_depth = depth

        if in_stacked and 'name="tasks"' in stripped:
            return stack_idx

        # End of stacked section
        if in_stacked and depth <= base_depth and prev_depth > base_depth:
            in_stacked = False

    return -1


def main():
    if not sys.argv[1:]:
        print("Usage: zp <prompt>")
        sys.exit(1)

    prompt = " ".join(sys.argv[1:])
    pane_name = prompt[:30]

    # Get current state
    original_pane = get_current_pane_id()
    layout = zellij("dump-layout")

    # Find tasks stack (usually index 1 - second stacked section)
    tasks_stack_idx = find_tasks_stack_index(layout)
    if tasks_stack_idx < 0:
        print("Could not find tasks pane in layout")
        sys.exit(1)

    # Navigate to tasks stack
    # From main pane, go right to first stack, right again to second stack
    # This assumes standard layout: main | stack1 | stack2
    moves_right = tasks_stack_idx + 1  # +1 because main pane is at 0

    for _ in range(moves_right):
        zellij("move-focus", "right")

    # Run claude in stacked mode
    subprocess.run([
        "zellij", "run", "--stacked", "--name", pane_name,
        "--", "claude", prompt
    ])

    # Return to original position
    for _ in range(moves_right):
        zellij("move-focus", "left")


if __name__ == "__main__":
    main()
