#!/usr/bin/env python3
"""
zp - Zellij Prompt: Run claude in rightmost stack, return focus to original pane.

This script integrates with a zellij layout that has stacked panes (like claude-dev.kdl).
It navigates to the rightmost pane, spawns a new claude session there, and returns focus
to your original pane so you can keep working.

Usage: zp [-v|--verbose] <prompt>
Example: zp "fix the type errors in auth.ts"
         zp -v "debug this issue"
"""

import argparse
import subprocess
import sys


def run(cmd: list[str]) -> str:
    """Run shell command and return stdout."""
    return subprocess.run(cmd, capture_output=True, text=True).stdout


def zellij_action(*args: str) -> str:
    """Run a zellij action command. Wraps: zellij action <args>"""
    return run(["zellij", "action", *args])


def dump_layout() -> str:
    """Get current pane layout info."""
    return run(["zellij", "action", "dump-layout"])


def main():
    parser = argparse.ArgumentParser(description="Run claude in rightmost stack pane")
    parser.add_argument("-v", "--verbose", action="store_true", help="Show pane layout before/after")
    parser.add_argument("prompt", nargs="+", help="Prompt to send to claude")
    args = parser.parse_args()

    prompt = " ".join(args.prompt)
    pane_name = prompt[:30]  # truncate for pane title
    verbose = args.verbose

    if verbose:
        print("=== BEFORE ===")
        print(dump_layout())

    # Spawn claude in the stack
    subprocess.run([
        "zellij", "run", "--stacked",
        "--", "claude", prompt
    ])

    # Give the pane a meaningful name
    zellij_action("rename-pane", pane_name)

    if verbose:
        print("=== AFTER ===")
        print(dump_layout())

    # TODO: this currently doesn't work at all. Need a way to track original pane.
    # Return focus to previous pane
    #zellij_action("focus-previous-pane")


if __name__ == "__main__":
    main()
